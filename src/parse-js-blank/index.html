<!doctype html>
<head>
  <meta charset="utf-8">

  <title>Interstellar Telephone</title>
  <meta name="description" content="Interstellar Telephone">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <!-- parse -->
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.1.min.js"></script>
  <!-- bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">
  <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script> -->
  <!-- audio js files-->
  <script type="text/javascript" src="./recorder.js"></script>
  <script type="text/javascript" src="./audio.js"></script>
</head>

<body>
  
  <div id="main">
    <h1>Interstellar Telephone</h1>
	
	<!-- shown when error retrieving something?-->
	<div style="display:none" class="error">
		<p>Sorry! Something went wrong</p>
	</div>
	
	<!-- shown when picking whether sending or receiving -->
	<div style="display:none" class="intro">
        <button type="button" class="btn btn-lg btn-default" id="record-btn">Record message</button>
        <button type="button" class="btn btn-lg btn-default" id="hear-btn">Hear message</button>
	</div>
	
	<!-- shown when recording -->
	<div style="display:none" class="record">
		<audio id="audioId" controls></audio>
		<div id="viz">
			<canvas id="analyser" width="200" height="100"></canvas>
			<canvas id="wavedisplay" width="200" height="100"></canvas>
		</div>
		<button type="button" class="btn btn-lg btn-default" id="capture-btn">Start/stop recording!</button>
		<button type="button" class="btn btn-lg btn-default" id="return-btn">I'm done</button>
		
	</div>
	
	<!-- shown when picking station -->
	<div style="display:none" class="station">
		<p>I am at station...</p>
		<p>
			<button type="button" class="btn btn-lg btn-default" id="mars-btn">Mars</button>
			<button type="button" class="btn btn-lg btn-default" id="jupiter-btn">Jupiter</button>
		</p>
		
	</div>
	
	 <!-- shown when counting down/playing sound -->
	<div style="display:none" class="SoundClass"> 
		<canvas id="canvasId" width="200" height="200">Canvas not supported - sorry, countdown timer won't work</canvas>

		<div class="audio">
			<audio id="audioId2" onplaying="playing()" controls>
			</audio>   
		</div>
		
		<button type="button" class="btn btn-lg btn-default" id="another-station-btn">Another station</button>
	</div>

  </div>
  
  <!-- non-parse written js-->
  <script type="text/javascript">
  
	function playing(){
	 //stuff in here happens while the audio is playing
	}
	
	function countdown(duration){
		var left = duration;
		for(var i = duration; i >= 0; i = i - 1){
			setTimeout("updateTime("+i+")", 1000 * (duration - i));
		}
		setTimeout(function(){ var a = document.getElementById("audioId2");a.play();}, 1000 * duration);
	}
	
	function updateTime(time){
		//alert(time);
		var c = document.getElementById("canvasId");
		var ctx = c.getContext("2d");
		ctx.fillStyle = "#ffffff";
		ctx.fillRect(0,0,200, 200);
		ctx.fillStyle = "#000000";
		ctx.font="150px Georgia";
		ctx.fillText(time, 10, 170, 200);
	}

  </script>

  <!-- Parse js -->
  <script type="text/javascript">
  
	window.onload = function(){
		window.onload;
		
		initAudio();
  
		Parse.initialize("ZL02sDEGakyzGqUMA8kYoHghsxEiiqZl6bVi7qEm", "PPDhLYI6Y5ygQF2gashX1ljqGHh9kU9AZUvyY1KW");
		
		
		$(".intro").show();
		
		$("#record-btn").click(function(){
			$(".intro").hide();
			$(".record").show();
		});
		
		$("#capture-btn").click(function(){
			toggleRecording(this);
		});
		
		$("#return-btn").click(function(){
			$(".record").hide();
			$(".station").show();
			
			//fetchWav();
			var messageObject = Parse.Object.extend("message");
			var query = new Parse.Query(messageObject);
			query.get(window.messageId, {
				success: function(messageObject) {
				// The object was retrieved successfully.
				alert("message in transit...");
				var messageinfo = messageObject.get("wav").get("message.wav");
				
				document.getElementById("audioId2").innerHTML += "<source src='" + messageinfo.base64 + "' />";
			  },
			  error: function(object, error) {
				// The object was not retrieved successfully.
				// error is a Parse.Error with an error code and message.
				alert("couldn't retrieve message");
			  }
			});;
			
		});
		
		$("#another-station-btn").click(function(){
			$(".SoundClass").hide();
			$(".station").show();
		});
		
		
		$("#hear-btn").click(function(){ 
			$(".intro").hide();
			$(".station").show();
			
			//fetchWav();
			
			var messageObject = Parse.Object.extend("message");
			var query = new Parse.Query(messageObject);
			query.get(window.messageId, {
				success: function(messageObject) {
				// The object was retrieved successfully.
				alert("message in transit...");
				var messageinfo = messageObject.get("wav").get("message.wav");
				
				$("#audioId2").innerHTML += "<source src='" + messageinfo.base64 + "' />";
			  },
			  error: function(object, error) {
				// The object was not retrieved successfully.
				// error is a Parse.Error with an error code and message.
				alert("couldn't retrieve message");
			  }
			});;
			
			
		});
		$("#mars-btn").click(function(){ 
			$(".station").hide();
			$(".SoundClass").show();
			countdown(3);
		});
		$("#jupiter-btn").click(function(){
			$(".station").hide();
			$(".SoundClass").show();
			countdown(10);
		});
		
	}
		
		
		/*
		function fetchWav(url){
			$.ajax({
					url:url,
					async:false,
					type:'POST',
					beforeSend:function(req){
							req.setRequestHeader('X-Parse-Application-Id',"ZL02sDEGakyzGqUMA8kYoHghsxEiiqZl6bVi7qEm");
							req.setRequestHeader('X-Parse-REST-API-Key',"PPDhLYI6Y5ygQF2gashX1ljqGHh9kU9AZUvyY1KW");
							req.setRequestHeader('Content-Type','audio/wav');
						},
					complete:function(rslt){
							$("#audioId2").src = 'data:audio/wav;base64,'+rslt.responseText;
						},
					success:function(){//Success},
					error:function(err){
							alert('Error: '+err.responseText+'\nCode: '+err.code);
						}
				})
			}
		
		*/
		
		/*
		if(listening){
			var TestObject = Parse.Object.extend("TestObject");
			var testObject = new TestObject();
			  testObject.save({foo: "bar"}, {
			  success: function(object) {
				$(".success").show();
			  },
			  error: function(model, error) {
			   $(".error").show();
				
			  }
			});
		} else {
			$(".choose").show();
			
			
		}*/
	
	
  </script>
</body>

</html>
